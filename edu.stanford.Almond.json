{
    "app-id" : "edu.stanford.Almond",
    "runtime" : "org.gnome.Platform",
    "runtime-version" : "3.34",
    "sdk" : "org.gnome.Sdk",
    "sdk-extensions" : [
        "org.freedesktop.Sdk.Extension.openjdk11",
        "org.freedesktop.Sdk.Extension.node10"
    ],
    "command" : "/app/bin/edu.stanford.Almond",
    "tags" : [
        "nightly"
    ],
    "finish-args" : [
        "--share=ipc",
        "--socket=x11",
        "--socket=wayland",
        "--socket=pulseaudio",
        "--share=network",
        "--device=dri",
        "--filesystem=host",
        "--talk-name=ca.desrt.dconf",
        "--system-talk-name=org.bluez",
        "--system-talk-name=org.freedesktop.login1",
        "--talk-name=org.gtk.vfs.Daemon",
        "--talk-name=org.gtk.vfs.mountpoint_http",
        "--talk-name=org.gnome.Shell.Screenshot",
        "--talk-name=org.freedesktop.secrets"
    ],
    "cleanup" : [
        "/include",
        "/lib/pkgconfig",
        "/share/pkgconfig",
        "/share/aclocal",
        "/lib/cmake",
        "/man",
        "/share/man",
        "/share/info",
        "/share/gtk-doc",
        "/share/vala",
        "/bin/npm",
        "/bin/antlr3",
        "/bin/pi",
        "/lib/yarn",
        "/bin/antlr3",
        "/share/java/antlr-3.4-complete.jar",
        "/bin/bazel",
        "/bin/yarn",
        "/bin/mimic*",
        "/bin/lfsc-checker",
        "/bin/compile_regexes",
        "/bin/t2p",
        "/bin/tclsh",
        "/bin/tclsh8.6",
        "/bin/sqlcipher",
        "/lib/tcl*",
        "/lib/libtcl*",
        "*.la",
        "*.a",
        "Makefile",
        "binding.gyp",
        "*.o",
        "*.d"
    ],
    "modules" : [
        {
            "name" : "lapack",
            "buildsystem" : "cmake",
            "builddir" : true,
            "config-opts" : [
                "-DBUILD_SHARED_LIBS=ON",
                "-DCBLAS=ON",
                "-DCMAKE_INSTALL_LIBDIR=lib"
            ],
            "sources" : [
                {
                    "type" : "archive",
                    "url" : "http://www.netlib.org/lapack/lapack-3.8.0.tar.gz",
                    "sha256" : "deb22cc4a6120bff72621155a9917f485f96ef8319ac074a7afbc68aab88bcf6"
                }
            ]
        },
        {
            "name" : "libantlr3",
            "config-opts" : [
                "--disable-static",
                "--enable-shared",
                "--disable-antlrdebug",
                "--with-pic"
            ],
            "rm-configure" : true,
            "build-options" : {
                "arch" : {
                    "x86_64" : {
                        "config-opts" : [
                            "--enable-64bit",
                            "--disable-static",
                            "--enable-shared",
                            "--disable-antlrdebug",
                            "--with-pic"
                        ]
                    },
                    "aarch64" : {
                        "config-opts" : [
                            "--enable-64bit",
                            "--disable-abiflags",
                            "--disable-static",
                            "--enable-shared",
                            "--disable-antlrdebug",
                            "--with-pic"
                        ]
                    },
                    "arm" : {
                        "config-opts" : [
                            "--disable-abiflags",
                            "--disable-static",
                            "--enable-shared",
                            "--disable-antlrdebug",
                            "--with-pic"
                        ]
                    }
                }
            },
            "sources" : [
                {
                    "type" : "archive",
                    "url" : "http://www.antlr3.org/download/C/libantlr3c-3.4.tar.gz",
                    "sha256" : "ca914a97f1a2d2f2c8e1fca12d3df65310ff0286d35c48b7ae5f11dcc8b2eb52"
                },
                {
                    "type" : "script",
                    "dest-filename" : "autogen.sh",
                    "commands" : [
                        "AUTOMAKE=\"automake --foreign\" autoreconf -vfi"
                    ]
                }
            ]
        },
        {
            "name" : "gmp",
            "config-opts" : [
                "--enable-cxx"
            ],
            "sources" : [
                {
                    "type" : "archive",
                    "url" : "https://gmplib.org/download/gmp/gmp-6.1.2.tar.xz",
                    "sha256" : "87b565e89a9a684fe4ebeeddb8399dce2599f9c9049854ca8c0dfbdea0e21912"
                }
            ]
        },
        {
            "name" : "antlr3",
            "buildsystem" : "simple",
            "build-commands" : [
                "install -m 0644 -D antlr-3.4-complete.jar /app/share/java/antlr-3.4-complete.jar",
                "install -m 0755 -D antlr3 /app/bin/antlr3"
            ],
            "sources" : [
                {
                    "type" : "file",
                    "url" : "https://www.antlr3.org/download/antlr-3.4-complete.jar",
                    "sha256" : "9d3e866b610460664522520f73b81777b5626fb0a282a5952b9800b751550bf7"
                },
                {
                    "type" : "script",
                    "dest-filename" : "antlr3",
                    "commands" : [
                        "export CLASSPATH=/app/share/java/antlr-3.4-complete.jar:$CLASSPATH",
                        "exec /usr/lib/sdk/openjdk11/jvm/openjdk-11/bin/java org.antlr.Tool \"$@\""
                    ]
                }
            ]
        },
        {
            "name" : "cvc4",
            "buildsystem" : "cmake",
            "config-opts" : [
                "-DCMAKE_BUILD_TYPE=Production",
                "-DENABLE_OPTIMIZED=ON",
                "-DUSE_CLN=OFF",
                "-DUSE_READLINE=OFF",
                "-DENABLE_GPL=OFF",
                "-DENABLE_PORTFOLIO=OFF",
                "-DJAVA_HOME=/usr/lib/sdk/openjdk11/jvm/openjdk-11"
            ],
            "sources" : [
                {
                    "type" : "archive",
                    "url" : "https://github.com/CVC4/CVC4/archive/1.7.tar.gz",
                    "sha256" : "9864a364a0076ef7ff63a46cdbc69cbe6568604149626338598d4df7788f8c2e"
                }
            ]
        },
        {
            "name" : "mimic",
            "config-opts" : [
                "--enable-shared",
                "--disable-static",
                "--with-audio=no"
            ],
            "sources" : [
                {
                    "type" : "git",
                    "url" : "https://github.com/MycroftAI/mimic",
                    "tag" : "1.2.0.2",
                    "commit" : "67e43bf0fa56008276b878ec3790aa5f32eb2a16"
                }
            ]
        },
        {
            "name" : "node",
            "buildsystem" : "simple",
            "build-commands" : [
                "install -Dm 755 /usr/lib/sdk/node10/bin/node /app/bin/node"
            ]
        },
        {
            "name" : "yarn",
            "buildsystem" : "simple",
            "build-commands" : [
                "cp -r . /app/lib/yarn",
                "ln -s /app/lib/yarn/bin/yarn /app/bin/yarn"
            ],
            "sources" : [
                {
                    "type" : "archive",
                    "url" : "https://github.com/yarnpkg/yarn/releases/download/v1.17.3/yarn-v1.17.3.tar.gz",
                    "sha256" : "e3835194409f1b3afa1c62ca82f561f1c29d26580c9e220c36866317e043c6f3"
                }
            ]
        },
        {
            "name" : "tcl",
            "config-opts" : [
            ],
            "post-install" : [
                "chmod u+w /app/lib/libtcl8.6.so"
            ],
            "subdir" : "unix",
            "sources" : [
                {
                    "type" : "archive",
                    "url" : "http://downloads.sourceforge.net/sourceforge/tcl/tcl-core8.6.8-src.tar.gz",
                    "sha256" : "85d4279d647bb705813c6453fa78040d74753bf707547723b124276749fc077d"
                }
            ]
        },
        {
            "name" : "sqlcipher",
            "config-opts" : [
                "--enable-tempstore=yes",
                "--enable-releasemode",
                "--disable-static",
                "--disable-tcl",
                "--disable-readline"
            ],
            "rm-configure" : true,
            "build-options" : {
                "env" : {
                    "CFLAGS" : "-g -O2 -DSQLITE_HAS_CODEC",
                    "LDFLAGS" : "-lcrypto"
                }
            },
            "sources" : [
                {
                    "type" : "archive",
                    "url" : "https://github.com/sqlcipher/sqlcipher/archive/v4.2.0.tar.gz",
                    "sha256" : "105c1b813f848da038c03647a8bfc9d42fb46865e6aaf4edfd46ff3b18cdccfc"
                },
                {
                    "type" : "script",
                    "dest-filename" : "autogen.sh",
                    "commands" : [
                        "AUTOMAKE=\"automake --foreign\" autoreconf -vfi"
                    ]
                }
            ]
        },
        {
            "name" : "hdf5",
            "config-opts" : [
                "--enable-fortran",
                "--enable-fortran2003",
                "--enable-cxx",
                "--enable-hl",
                "--enable-shared",
                "--disable-static",
                "--disable-java"
            ],
            "sources" : [
                {
                    "type" : "archive",
                    "url" : "https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.10/hdf5-1.10.5/src/hdf5-1.10.5.tar.bz2",
                    "sha256" : "68d6ea8843d2a106ec6a7828564c1689c7a85714a35d8efafa2fee20ca366f44"
                }
            ]
        },
        {
            "name" : "bazel",
            "buildsystem": "simple",
            "build-commands": [
                "ln -s /usr/bin/python3 /app/bin/python",
                "./compile.sh",
                "install -m 0755 -D output/bazel /app/bin/bazel",
                "rm /app/bin/python"
            ],
            "build-options": {
                "strip": false,
                "no-debuginfo": true,
                "no-debuginfo-compression": true,
                "env" : {
                    "EXTRA_BAZEL_ARGS": "--host_javabase=@local_jdk//:jdk --python_path=/usr/bin/python3",
                    "JAVA_HOME": "/usr/lib/sdk/openjdk11/jvm/openjdk-11"
                }
            },
            "sources": [
                {
                    "type" : "archive",
                    "url": "https://github.com/bazelbuild/bazel/releases/download/0.29.1/bazel-0.29.1-dist.zip",
                    "sha256": "872a52cff208676e1169b3e1cae71b1fe572c4109cbd66eab107d8607c378de5",
                    "strip-components": 0
                },
                {
                    "type": "patch",
                    "path": "build-data/grpc_rename_gettid.patch",
                    "strip-components": 0,
                    "options": [ "-d", "third_party/grpc" ]
                }
            ]
        },

        "./build-data/python3-numpy.json",
        "./build-data/python3-pkgconfig.json",
        "./build-data/python3-pbr.json",
        "./build-data/python3-Cython.json",
        "./build-data/python3-h5py.json",
        "./build-data/python3-scipy.json",
        "./build-data/python3-speechpy-fast.json",
        "./build-data/python3-sonopy.json",
        "./build-data/python3-wavio.json",
        "./build-data/python3-prettyparse.json",
        "./build-data/python3-typing.json",
        "./build-data/python3-attrs.json",
        {
            "name": "c-ares",
            "buildsystem": "cmake",
            "sources": [
                {
                    "type": "archive",
                    "url": "http://c-ares.haxx.se/download/c-ares-1.15.0.tar.gz",
                    "sha256": "6cdb97871f2930530c97deb7cf5c8fa4be5a0b02c7cea6e7c7667672a39d6852"
                }
            ],
            "config-opts": [
                "-DCMAKE_INSTALL_LIBDIR:PATH=/app/lib",
                "-DCARES_BUILD_TOOLS:BOOL=OFF"
            ]
        },
        {
            "name": "protobuf",
            "buildsystem": "autotools",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/protocolbuffers/protobuf/archive/v3.7.1/protobuf-3.7.1-all.tar.gz",
                    "sha256": "f1748989842b46fa208b2a6e4e2785133cfcc3e4d43c17fecb023733f0f5443f"
                }
            ],
            "post-install": [
                "cd python; python3 setup.py install --prefix=/app",
                "rm /app/lib/libprotobuf*.a",
                "rm /app/lib/python3.7/site-packages/easy-install.pth"
            ]
        },
        {
            "name": "grpc",
            "buildsystem": "simple",
            "build-commands": [
                "make prefix=/app",
                "make prefix=/app install",
                "python3 setup.py install --prefix=/app",
                "rm /app/lib/libgrpc*.a",
                "rm /app/lib/python3.7/site-packages/easy-install.pth"
            ],
            "build-options" : {
                "env" : {
                    "CFLAGS" : "-g -O2 -Wno-error",
                    "CXXFLAGS" : "-g -O2 -Wno-error",
                    "GRPC_PYTHON_BUILD_WITH_CYTHON": "True",
                    "GRPC_PYTHON_BUILD_SYSTEM_OPENSSL": "True",
                    "GRPC_PYTHON_BUILD_SYSTEM_ZLIB": "True",
                    "GRPC_PYTHON_BUILD_SYSTEM_CARES": "True",
                    "GRPC_PYTHON_DISABLE_LIBC_COMPATIBILITY": "True"
                }
            },
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/grpc/grpc/archive/4566c2a29ebec0835643b972eb99f4306c4234a3.tar.gz",
                    "sha256": "67a6c26db56f345f7cee846e681db2c23f919eba46dd639b09462d1b6203d28c"
                },
                {
                    "type": "patch",
                    "path": "build-data/grpc_rename_gettid.patch",
                    "strip-components": 0
                }
            ]
        },
        "./build-data/python3-tensorflow-deps.json",
        "./build-data/python3-keras.json",
        "./build-data/python3-wrapt.json",
        {
            "name": "tensorflow",
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p tensorflow_pkg",
                "mkdir -p /run/ccache/bazel",
                "ln -s /usr/bin/python3 /app/bin/python",
                "bazel --output_user_root=/run/ccache/bazel build --incompatible_no_support_tools_in_action_inputs=false --distdir=\"${PWD}/bazel-distdir\" --config=opt --config=nogcp --config=noaws --config=nohdfs --config=noignite --config=nokafka //tensorflow/tools/pip_package:build_pip_package",
                "PYTHON_BIN_PATH=/usr/bin/python3 ./bazel-bin/tensorflow/tools/pip_package/build_pip_package tensorflow_pkg/",
                "pip3 install --no-index --no-build-isolation --prefix=/app tensorflow_pkg/tensorflow-*.whl",
                "rm /app/bin/python"
            ],
            "build-options": {
                "env" : {
                    "JAVA_HOME": "/usr/lib/sdk/openjdk11/jvm/openjdk-11"
                }
            },
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/tensorflow/tensorflow/archive/87989f69597d6b2d60de8f112e1e3cea23be7298.tar.gz",
                    "sha256": "c4da79385dfbfb30c1aaf73fae236bc6e208c3171851dfbe0e1facf7ca127a6a"
                },
                {
                    "type": "file",
                    "path": "build-data/tensorflow.bazelrc",
                    "dest-filename": ".tf_configure.bazelrc"
                },
                "./build-data/tensorflow-bazel-deps.json"
            ]
        },
        {
            "name" : "mycroft-precise",
            "buildsystem" : "simple",
            "build-commands" : [
                "pip3 install . --prefix=/app"
            ],
            "sources" : [
                {
                    "type" : "git",
                    "url" : "https://github.com/MycroftAI/mycroft-precise",
                    "tag" : "v0.3.0",
                    "commit" : "e06f92bf3119837cf314ba63b957277116ef1e6b"
                },
                {
                    "type" : "patch",
                    "path" : "build-data/mycroft-precise-deps.patch"
                },
                {
                    "type" : "patch",
                    "path" : "build-data/mycroft-precise-model.patch"
                }
            ]
        },
        {
            "name" : "almond-gnome",
            "buildsystem" : "meson",
            "build-options" : {
                "env" : {
                    "npm_config_nodedir" : "/usr/lib/sdk/node10"
                }
            },
            "sources" : [
                {
                    "type" : "git",
                    "url" : "https://github.com/stanford-oval/almond-gnome"
                },
                "../build-data/yarn.json"
            ]
        }
    ],
    "build-options" : {
        "env" : {
            "npm_config_build_from_source" : "true",
            "npm_config_sqlite" : "/app",
            "npm_config_sqlite_libname" : "sqlcipher",
            "PYTHONDONTWRITEBYTECODE" : "1",
            "ALMOND_SPAWN_SERVICE_MANUALLY" : "1"
        }
    }
}
